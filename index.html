<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日経225 攻略するぞ!!</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="data.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --completed-color: #dc2626;
            /* Red for completed */
            --incomplete-color: #4b5563;
            /* Gray for incomplete */
            --stroke-color: #1a1a1a;
            --hover-stroke: #ffffff;
            --tooltip-bg: rgba(0, 0, 0, 0.9);
            --header-bg: #000;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            overflow: hidden;
            /* Prevent scrolling */
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background-color: var(--header-bg);
            border-bottom: 1px solid #333;
            height: 50px;
            box-sizing: border-box;
        }

        #title-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #title {
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }

        #back-button {
            display: none;
            /* Initially hidden */
            padding: 5px 15px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        #back-button:hover {
            background-color: #555;
        }

        #progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #progress-bar-bg {
            width: 200px;
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
        }

        #progress-bar-fill {
            height: 100%;
            background-color: var(--completed-color);
            width: 0%;
            transition: width 1s ease-in-out;
        }

        #progress-text {
            font-size: 0.9rem;
            color: #ccc;
        }

        #chart-container {
            width: 100vw;
            height: calc(100vh - 51px);
            position: relative;
        }

        /* Tooltip */
        #tooltip {
            position: absolute;
            background-color: var(--tooltip-bg);
            color: white;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.9rem;
            border: 1px solid #555;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #tooltip .tooltip-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #ef4444;
        }

        #tooltip .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            font-size: 0.8rem;
            color: #ccc;
        }
    </style>
</head>

<body>

    <div id="header">
        <div id="title-area">
            <div id="title" onclick="resetZoom()">日経225 攻略するぞ!!</div>
            <button id="back-button" onclick="resetZoom()">← 全体に戻る</button>
        </div>

        <div id="progress-container">
            <div id="progress-bar-bg">
                <div id="progress-bar-fill"></div>
            </div>
            <div id="progress-text">0 / 225 (0%)</div>
        </div>
    </div>

    <div id="chart-container"></div>
    <div id="tooltip"></div>

    <script>
        // --- 1. データ処理 ---
        function enrichData(node) {
            if (node.children) {
                node.children.forEach(child => enrichData(child));
            } else {
                const linkUrl = videoLinks[node.code] || (node.url && node.url.length > 0 ? node.url : null);
                if (linkUrl) {
                    node.completed = true;
                    node.url = linkUrl;
                } else {
                    node.completed = false;
                    node.url = null;
                }
            }
        }
        enrichData(marketData);

        let totalStocks = 0;
        let completedStocks = 0;
        function countProgress(node) {
            if (node.children) {
                node.children.forEach(child => countProgress(child));
            } else {
                totalStocks++;
                if (node.completed) completedStocks++;
            }
        }
        countProgress(marketData);

        const percentage = totalStocks > 0 ? (completedStocks / totalStocks * 100).toFixed(1) : 0;
        document.getElementById('progress-text').innerText = `分析完了: ${completedStocks} (${percentage}%)`;
        document.getElementById('progress-bar-fill').style.width = `${percentage}%`;


        // --- 2. D3.js 描画 ---
        const container = document.getElementById('chart-container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        const svg = d3.select("#chart-container")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("font-family", "Helvetica Neue, Arial, sans-serif");

        let root = d3.hierarchy(marketData)
            .sum(d => d.marketCap)
            .sort((a, b) => b.value - a.value);

        d3.treemap()
            .size([width, height])
            .paddingInner(1)
            .paddingTop(22)
            .paddingRight(1)
            .paddingBottom(1)
            .paddingLeft(1)
            .round(true)
            (root);

        let focus = root;
        let view;

        // ノードグループ作成
        const cell = svg.selectAll("g")
            .data(root.descendants())
            .enter().append("g")
            .attr("transform", d => `translate(${d.x0},${d.y0})`);

        // 短形描画
        cell.append("rect")
            .attr("width", d => d.x1 - d.x0)
            .attr("height", d => d.y1 - d.y0)
            .attr("fill", d => {
                if (d.depth === 0) return "none";
                if (d.children) return "#333";
                return d.data.completed ? "var(--completed-color)" : "var(--incomplete-color)";
            })
            .attr("stroke", d => d.depth === 1 ? "#000" : "var(--stroke-color)")
            .attr("stroke-width", 1)
            .style("cursor", d => (d.depth === 1 || d.data.completed) ? "pointer" : "default")
            .on("mouseover", function (event, d) {
                if (d.children) return;

                const tooltip = d3.select("#tooltip");
                tooltip.style("opacity", 1)
                    .html(`
                        <div class="tooltip-header">${d.data.name}</div>
                        <div class="tooltip-row"><span>コード</span> <span>${d.data.code}</span></div>
                        <div class="tooltip-row"><span>時価総額</span> <span>${(d.data.marketCap / 10000).toFixed(1)}兆円</span></div>
                        <div class="tooltip-row"><span>状態</span> <span>${d.data.completed ? "動画あり" : "未分析"}</span></div>
                    `);

                let left = event.pageX + 10;
                let top = event.pageY + 10;
                if (left + 200 > window.innerWidth) left = event.pageX - 210;
                if (top + 100 > window.innerHeight) top = event.pageY - 110;

                tooltip.style("left", left + "px").style("top", top + "px");

                d3.select(this).attr("stroke", "var(--hover-stroke)").attr("stroke-width", 2);
            })
            .on("mouseout", function (event, d) {
                if (d.children) return;
                d3.select("#tooltip").style("opacity", 0);
                d3.select(this).attr("stroke", "var(--stroke-color)").attr("stroke-width", 1);
            })
            .on("click", function (event, d) {
                if (focus !== d) {
                    if (d.children) {
                        zoom(d);
                    } else if (d.data.completed && d.data.url) {
                        window.open(d.data.url, '_blank');
                    }
                    event.stopPropagation();
                }
            });

        // --- CLIP PATH REMOVED ---
        // クリップパスはテキスト消失の原因になるため削除し、overflowで対応

        // テキストラベル（一括管理）
        const text = cell.append("text")
            .attr("x", d => d.depth === 1 ? 4 : (d.x1 - d.x0) / 2)
            .attr("y", d => d.depth === 1 ? 14 : (d.y1 - d.y0) / 2)
            .style("text-anchor", d => d.depth === 1 ? "start" : "middle")
            .style("dominant-baseline", d => d.depth === 1 ? "auto" : "central") /* 垂直中央揃え */
            .style("fill", "white")
            .style("text-shadow", d => d.depth === 1 ? "1px 1px 2px black" : "0px 0px 3px rgba(0,0,0,0.8)")
            .style("font-weight", d => d.depth === 1 ? "bold" : "normal")
            .style("font-size", d => d.depth === 1 ? "13px" : Math.min(12, (d.x1 - d.x0) / 4) + "px")
            .style("pointer-events", "none") // クリックイベントをRectに通す
            .text(d => d.data.name)
            .style("opacity", d => {
                if (d.depth === 1) return 1;
                if (d.depth === 2) {
                    // 表示閾値をさらに緩和 (10px以上)
                    // オーバーフローしても表示させる（視認性優先）
                    return ((d.x1 - d.x0) > 10 && (d.y1 - d.y0) > 10) ? 1 : 0;
                }
                return 0;
            });

        // ズーム関数
        function zoom(d) {
            const focus0 = focus;
            focus = d;

            // スケール係数計算
            const k = width / (focus.x1 - focus.x0);

            // "Back" ボタン
            const backBtn = document.getElementById("back-button");
            const title = document.getElementById("title");

            if (focus === root) {
                backBtn.style.display = "none";
                title.innerText = "日経225 攻略マップ";
            } else {
                backBtn.style.display = "block";
                title.innerText = `日経225 > ${d.data.name}`;
            }

            const transition = svg.transition()
                .duration(750)
                .tween("zoom", d => {
                    const i = d3.interpolateZoom(view, [focus.x0, focus.y0, focus.x1 - focus.x0]);
                    return t => zoomTo(i(t));
                });

            // ラベル表示切り替え
            text.transition(transition)
                .style("opacity", d => {
                    if (focus === root) {
                        if (d.depth === 1) return 1;
                        if (d.depth === 2 && (d.x1 - d.x0) > 10) return 1;
                        return 0;
                    }

                    // セクターにズーム中
                    if (d === focus) return 1;
                    if (d.parent === focus) return 1;
                    return 0;
                })
                .style("font-size", d => {
                    const baseWidth = d.x1 - d.x0;
                    const visualWidth = baseWidth * k;

                    // セクタータイトル
                    if (d === focus && d.depth === 1) return "16px";

                    // ズーム中の銘柄名
                    if (d.parent === focus) {
                        return Math.min(16, visualWidth / 4) + "px";
                    }

                    // その他の場合
                    return d.depth === 1 ? "13px" : Math.min(12, visualWidth / 4) + "px";
                })
                .attr("x", d => {
                    return d.depth === 1 ? 4 : (d.x1 - d.x0) / 2;
                });
        }

        window.resetZoom = function () {
            zoom(root);
        }

        function zoomTo(v) {
            const k = width / v[2]; view = v;

            cell.attr("transform", d => `translate(${(d.x0 - v[0]) * k},${(d.y0 - v[1]) * k})`);

            cell.select("rect")
                .attr("width", d => (d.x1 - d.x0) * k)
                .attr("height", d => (d.y1 - d.y0) * k);

            text.filter(d => d.depth !== 1)
                .attr("x", d => (d.x1 - d.x0) * k / 2)
                .attr("y", d => (d.y1 - d.y0) * k / 2);

            text.filter(d => d.depth === 1)
                .attr("x", 4)
                .attr("y", 14);
        }

        zoomTo([root.x0, root.y0, root.x1 - root.x0]);
        svg.on("click", () => zoom(root));
        window.addEventListener('resize', () => { location.reload(); });

    </script>
</body>

</html>